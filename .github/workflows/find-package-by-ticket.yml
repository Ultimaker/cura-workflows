name: Conan Package Discovery by Jira Ticket

on:
  workflow_call:
    inputs:
      jira_ticket_number:
        default: ''
        required: true
        type: string
      channel:
        default: 'ultimaker'
        required: false
        type: string
    outputs:
      discovered_packages:
        description: "All discovered packages"
        value: ${{ jobs.find-packages.outputs.discovered_packages }}
      cura_package:
        description: "Cura package"
        value: ${{ jobs.find-packages.outputs.cura_package }}
      package_overrides:
        description: "Overrides"
        value: ${{ jobs.find-packages.outputs.package_overrides }}

permissions:
  contents: read

jobs:
  find-packages:
    runs-on: ubuntu-latest
    outputs:
      discovered_packages: ${{ steps.conan_search.outputs.discovered_packages }}
      cura_package: ${{ steps.conan_search.outputs.cura_package }}
      package_overrides: ${{ steps.conan_search.outputs.package_overrides }}
    steps:
      - name: Setup the build environment
        uses: ultimaker/cura-workflows/.github/actions/setup-build-environment@update_package_find_workflow_deduplicate
        with:
          conan_user: ${{ secrets.CONAN_USER }}
          conan_password: ${{ secrets.CONAN_PASS }}
          private_data: true

      - name: Checkout our feature branch for the script
        uses: actions/checkout@v4
        with:
          repository: Ultimaker/cura-workflows
          path: Cura-workflows
          ref: update_package_find_workflow_deduplicate

      - name: Validate Jira Ticket Number Format
        id: validate_input
        uses: actions/github-script@v7
        with:
          script: |
            const inputTicket = '${{ inputs.jira_ticket_number }}';
            let normalizedTicket = inputTicket.toLowerCase().replace(/-/g, '_');

            if (/^[0-9]+$/.test(normalizedTicket)) {
              normalizedTicket = `cura_${normalizedTicket}`;
            }

            const keyword = normalizedTicket.split('_')[0];
            const numberMatch = normalizedTicket.match(/[0-9]+/);
            const number = numberMatch ? numberMatch[0] : null;

            if (!['cura', 'np', 'pp'].includes(keyword)) {
              return core.setFailed("Invalid Jira ticket keyword. Expected one of: cura, np, pp.");
            }
            if (number === null) {
              return core.setFailed("No number found in Jira ticket input.");
            }

            const fixedTicket = `${keyword}_${number}`;
            console.log(`Jira ticket number normalized to '${fixedTicket}'.`);
            core.setOutput('jira_ticket_number', fixedTicket);

      - name: Discover Conan Packages
        id: conan_search
        uses: actions/github-script@v7
        with:
          script: |
            const jiraTicket = '${{ steps.validate_input.outputs.jira_ticket_number }}';
            const buildChannel = '${{ inputs.channel }}'
            const conanPkgRef = `*/*@${buildChannel}/${jiraTicket}`;

            // Python script handles everything including writing to GITHUB_STEP_SUMMARY
            let pythonOutput = '';
            const pythonOptions = {
              ignoreReturnCode: true,
              listeners: {
                stdout: (data) => { pythonOutput += data.toString(); },
                stderr: (data) => { console.log('Python:', data.toString()); }
              }
            };

            try {
              const exitCode = await exec.exec('python3', [
                'Cura-workflows/runner_scripts/conan_package_finder.py',
                '--search-pattern', conanPkgRef,
                '--jira-ticket', jiraTicket,
                '--output-format', 'github-summary'
              ], pythonOptions);

              if (exitCode === 0 && pythonOutput.trim()) {
                // Parse the JSON response containing workflow outputs
                const outputs = JSON.parse(pythonOutput.trim());
                
                console.log(`Setting workflow outputs: discovered_packages="${outputs.discovered_packages}", cura_package="${outputs.cura_package}", package_overrides="${outputs.package_overrides}"`);

                // Set workflow outputs
                core.setOutput('discovered_packages', outputs.discovered_packages);
                core.setOutput('cura_package', outputs.cura_package);
                core.setOutput('package_overrides', outputs.package_overrides);

                // Summary was already written by Python to GITHUB_STEP_SUMMARY
              } else {
                throw new Error('Python script failed or returned no output');
              }
              
            } catch (error) {
              console.log(`Package search failed: ${error.message}`);
              
              // Set empty outputs
              core.setOutput('discovered_packages', '');
              core.setOutput('cura_package', '');
              core.setOutput('package_overrides', '');
              
              // Write failure summary directly since Python couldn't
              await core.summary
                .addHeading(`Conan Packages Found for Jira Ticket: ${jiraTicket}`)
                .addRaw(`The workflow searched for Conan packages matching the pattern \`${conanPkgRef}\` across all configured remotes.`)
                .addHeading('Discovered Packages:', 2)
                .addRaw('*No packages found matching the specified tag.*')
                .write();
            }
