name: Conan Package Discovery by Jira Ticket

on:
  workflow_call:
    inputs:
      jira_ticket_number:
        default: ''
        required: true
        type: string
      channel:
        default: 'ultimaker'
        required: false
        type: string
      validate_input:
        description: 'Whether to validate the input Jira ticket number format'
        default: true
        required: false
        type: boolean
    outputs:
      discovered_packages:
        description: "All discovered packages"
        value: ${{ jobs.find-packages.outputs.discovered_packages }}
      cura_package:
        description: "Cura package"
        value: ${{ jobs.find-packages.outputs.cura_package }}
      package_overrides:
        description: "Overrides"
        value: ${{ jobs.find-packages.outputs.package_overrides }}

permissions:
  contents: read

jobs:
  find-packages:
    runs-on: ubuntu-latest
    outputs:
      discovered_packages: ${{ steps.conan_search.outputs.discovered_packages }}
      cura_package: ${{ steps.conan_search.outputs.cura_package }}
      package_overrides: ${{ steps.conan_search.outputs.package_overrides }}
    steps:
      - name: Setup the build environment
        uses: ultimaker/cura-workflows/.github/actions/setup-build-environment@main
        with:
          conan_user: ${{ secrets.CONAN_USER }}
          conan_password: ${{ secrets.CONAN_PASS }}
          private_data: true

      - name: Discover Conan Packages
        id: conan_search
        uses: actions/github-script@v7
        with:
          script: |
            let pythonOutput = '';
            const pythonOptions = {
              ignoreReturnCode: true,
              listeners: {
                stdout: (data) => { pythonOutput += data.toString(); },
                stderr: (data) => { console.log('Python:', data.toString()); }
              }
            };

            try {
              const exitCode = await exec.exec('python3', [
                'Cura-workflows/runner_scripts/conan_package_finder.py',
                '--jira-ticket', '${{ inputs.jira_ticket_number }}',
                '--channel', '${{ inputs.channel }}',
                '--validate-input', '${{ inputs.validate_input }}',
                '--output-format', 'github-summary',
                '--summary-output', process.env.GITHUB_STEP_SUMMARY
              ], pythonOptions);

              if (exitCode === 0 && pythonOutput.trim()) {
                const outputs = JSON.parse(pythonOutput.trim());
                
                console.log(`Setting workflow outputs: discovered_packages="${outputs.discovered_packages}", cura_package="${outputs.cura_package}", package_overrides="${outputs.package_overrides}"`);

                // Set workflow outputs
                core.setOutput('discovered_packages', outputs.discovered_packages);
                core.setOutput('cura_package', outputs.cura_package);
                core.setOutput('package_overrides', outputs.package_overrides);
              } else {
                throw new Error('Python script failed or returned no output');
              }
            } catch (error) {
              console.log(`Package search failed: ${error.message}`);
              
              // Set empty outputs
              core.setOutput('discovered_packages', '');
              core.setOutput('cura_package', '');
              core.setOutput('package_overrides', '');
              
              // Write failure summary directly since Python couldn't
              const jiraTicket = '${{ inputs.jira_ticket_number }}';
              const buildChannel = '${{ inputs.channel }}';
              await core.summary
                .addHeading(`Conan Packages Found for Jira Ticket: ${jiraTicket}`)
                .addRaw(`The workflow searched for Conan packages in channel \`${buildChannel}\`.`)
                .addHeading('Discovered Packages:', 2)
                .addRaw('*No packages found or script failed.*')
                .write();
            }
