name: NPM package

on:
  workflow_call:
    inputs:
      package_version_full:
        required: true
        type: string

      private_data:
        required: false
        default: false
        type: boolean

      conan_extra_args:
        required: false
        default: ""
        type: string

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # STEP 1: Add this checkout step.
      # This is crucial to make your repository files, including the new tsconfig.json,
      # available to the runner.
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup the build environment
        uses: ultimaker/cura-workflows/.github/actions/setup-build-environment@main
        with:
          private_data: ${{ inputs.private_data }}
          conan_user: ${{ secrets.CONAN_USER }}
          conan_password: ${{ secrets.CONAN_PASS }}
          install_system_dependencies: true
          repository_path: _sources

      - name: Upgrade TypeScript and Node types
        run: |
          npm install --save-dev typescript@latest @types/node@latest
          rm -rf node_modules package-lock.json
          npm install

      - name: Create tsconfig.json
        run: |
          echo '{
            "compilerOptions": {
              "skipLibCheck": true,
              "target": "ES2020"
            }
          }' > tsconfig.json

      - name: Gather/build the packages
        # This step will now succeed because tsc will find and use your local tsconfig.json
        run: conan install --requires "${{ inputs.package_version_full }}" -pr:h cura_wasm.jinja -g npm --build=missing --update ${{ inputs.conan_extra_args }} -of .

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          registry-url: 'https://npm.pkg.github.com'
          scope: '@ultimaker'

      - name: Install NPM dependencies
        run: npm install

      - name: Publish to GitHub Packages
        run: |
          npm publish
        env:
          # Use the default GITHUB_TOKEN for publishing to GitHub Packages
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload all packages on a push to main
        if: ${{ github.ref_name == 'main' && github.event_name == 'push' }}
        uses: ultimaker/cura-workflows/.github/actions/upload-conan-package@main
